{
  "analysis_date": "2026-01-18",
  "project": "HABIKO Email System",
  "status": "INCOHÉRENT - Corrections requises",
  
  "summary": {
    "total_email_calls": 10,
    "coherent_calls": 5,
    "incoherent_calls": 5,
    "critical_issues": 2,
    "medium_issues": 1,
    "orphaned_templates": 4
  },
  
  "issues": [
    {
      "id": "ISSUE-001",
      "severity": "CRITICAL",
      "type": "MISSING_TXT_TEMPLATE",
      "description": "Template .txt mal nommé - version texte jamais utilisée",
      "file": "accounts/tasks.py",
      "function": "send_ad_published_email",
      "line": 189,
      "template_called": "account/email/ad_published",
      "expected_files": [
        "templates/account/email/ad_published.html",
        "templates/account/email/ad_published.txt"
      ],
      "actual_files": [
        "templates/account/email/ad_published.html",
        "templates/account/email/ad_published_message.txt"
      ],
      "fix_action": "RENAME_FILE",
      "fix_details": {
        "from": "templates/account/email/ad_published_message.txt",
        "to": "templates/account/email/ad_published.txt"
      },
      "context_variables": ["user", "ad", "site_name", "site_url", "ad_url"]
    },
    {
      "id": "ISSUE-002",
      "severity": "CRITICAL",
      "type": "MISSING_TXT_TEMPLATE",
      "description": "Template .txt mal nommé - version texte jamais utilisée",
      "file": "accounts/tasks.py",
      "function": "send_login_notification_email",
      "line": 221,
      "template_called": "account/email/login_notification",
      "expected_files": [
        "templates/account/email/login_notification.html",
        "templates/account/email/login_notification.txt"
      ],
      "actual_files": [
        "templates/account/email/login_notification.html",
        "templates/account/email/login_notification_message.txt"
      ],
      "fix_action": "RENAME_FILE",
      "fix_details": {
        "from": "templates/account/email/login_notification_message.txt",
        "to": "templates/account/email/login_notification.txt"
      },
      "context_variables": ["user", "site_name", "site_url"]
    },
    {
      "id": "ISSUE-003",
      "severity": "CRITICAL",
      "type": "MISSING_TXT_TEMPLATE",
      "description": "Template .txt mal nommé - version texte jamais utilisée",
      "file": "accounts/tasks.py",
      "function": "send_password_change_email",
      "line": 261,
      "template_called": "account/email/password_change",
      "expected_files": [
        "templates/account/email/password_change.html",
        "templates/account/email/password_change.txt"
      ],
      "actual_files": [
        "templates/account/email/password_change.html",
        "templates/account/email/password_change_message.txt"
      ],
      "fix_action": "RENAME_FILE",
      "fix_details": {
        "from": "templates/account/email/password_change_message.txt",
        "to": "templates/account/email/password_change.txt"
      },
      "context_variables": ["user", "site_name", "site_url"]
    },
    {
      "id": "ISSUE-004",
      "severity": "CRITICAL",
      "type": "MISSING_TXT_TEMPLATE",
      "description": "Template .txt mal nommé - version texte jamais utilisée",
      "file": "accounts/tasks.py",
      "function": "send_ad_expiration_email",
      "line": 301,
      "template_called": "account/email/ad_expiration",
      "expected_files": [
        "templates/account/email/ad_expiration.html",
        "templates/account/email/ad_expiration.txt"
      ],
      "actual_files": [
        "templates/account/email/ad_expiration.html",
        "templates/account/email/ad_expiration_message.txt"
      ],
      "fix_action": "RENAME_FILE",
      "fix_details": {
        "from": "templates/account/email/ad_expiration_message.txt",
        "to": "templates/account/email/ad_expiration.txt"
      },
      "context_variables": ["user", "ad", "site_name", "site_url", "ad_url"]
    },
    {
      "id": "ISSUE-005",
      "severity": "MEDIUM",
      "type": "INCORRECT_TEMPLATE_PATH",
      "description": "Chemin de template incomplet - template HTML jamais utilisé",
      "file": "accounts/tasks.py",
      "function": "send_account_created_email",
      "line": 142,
      "template_called": "account_created",
      "expected_template": "account/email/account_created",
      "template_exists": true,
      "fix_action": "UPDATE_CODE",
      "fix_details": {
        "file": "accounts/tasks.py",
        "line": 142,
        "current": "template_name=\"account_created\",",
        "new": "template_name=\"account/email/account_created\","
      },
      "context_variables": ["user", "confirmation_url", "site_url"]
    }
  ],
  
  "coherent_calls": [
    {
      "file": "accounts/views.py",
      "function": "password_change",
      "line": 80,
      "template": "account/email/password_change_otp",
      "status": "OK",
      "files_found": [
        "templates/account/email/password_change_otp.html",
        "templates/account/email/password_change_otp.txt"
      ]
    },
    {
      "file": "accounts/views.py",
      "function": "resend_password_change_code",
      "line": 149,
      "template": "account/email/password_change_otp",
      "status": "OK",
      "files_found": [
        "templates/account/email/password_change_otp.html",
        "templates/account/email/password_change_otp.txt"
      ]
    },
    {
      "file": "ads/tasks.py",
      "function": "send_moderation_notification",
      "line": 98,
      "template": "account/email/ad_approved",
      "status": "OK",
      "files_found": [
        "templates/account/email/ad_approved.html",
        "templates/account/email/ad_approved.txt"
      ]
    },
    {
      "file": "ads/tasks.py",
      "function": "send_moderation_notification",
      "line": 98,
      "template": "account/email/ad_rejected",
      "status": "OK",
      "files_found": [
        "templates/account/email/ad_rejected.html",
        "templates/account/email/ad_rejected.txt"
      ]
    },
    {
      "file": "accounts/adapters.py",
      "function": "send_mail",
      "line": 98,
      "template": "account/email/email_confirmation",
      "status": "OK",
      "note": "Utilise _message.txt et _subject.txt (format Allauth)",
      "files_found": [
        "templates/account/email/email_confirmation.html",
        "templates/account/email/email_confirmation_message.txt",
        "templates/account/email/email_confirmation_subject.txt"
      ]
    },
    {
      "file": "accounts/adapters.py",
      "function": "send_mail",
      "line": 98,
      "template": "account/email/password_reset",
      "status": "OK",
      "note": "Utilise _message.txt et _subject.txt (format Allauth)",
      "files_found": [
        "templates/account/email/password_reset.html",
        "templates/account/email/password_reset_message.txt",
        "templates/account/email/password_reset_subject.txt"
      ]
    }
  ],
  
  "templates_inventory": {
    "html_templates": [
      "account_created.html",
      "ad_approved.html",
      "ad_expiration.html",
      "ad_published.html",
      "ad_rejected.html",
      "base_email.html",
      "email_confirmation.html",
      "login_notification.html",
      "password_change_otp.html",
      "password_change.html",
      "password_reset.html"
    ],
    "txt_templates": [
      "account_created.txt",
      "ad_approved.txt",
      "ad_expiration_message.txt",
      "ad_published_message.txt",
      "ad_rejected.txt",
      "email_confirmation_message.txt",
      "email_confirmation_subject.txt",
      "login_notification_message.txt",
      "password_change_message.txt",
      "password_change_otp.txt",
      "password_reset_message.txt",
      "password_reset_subject.txt"
    ],
    "orphaned_txt_files": [
      "ad_published_message.txt",
      "login_notification_message.txt",
      "password_change_message.txt",
      "ad_expiration_message.txt"
    ]
  },
  
  "email_service_behavior": {
    "template_lookup": "Ajoute automatiquement .html et .txt au template_name",
    "example": {
      "input": "account/email/ad_published",
      "searches": [
        "account/email/ad_published.html",
        "account/email/ad_published.txt"
      ]
    },
    "fallback": "Utilise text_content si template non trouvé",
    "warning": "Les templates *_message.txt ne sont PAS trouvés automatiquement"
  },
  
  "recommended_fixes": [
    {
      "priority": 1,
      "type": "RENAME",
      "action": "Renommer 4 fichiers .txt pour correspondre au système de nommage EmailService",
      "commands": [
        "mv templates/account/email/ad_published_message.txt templates/account/email/ad_published.txt",
        "mv templates/account/email/login_notification_message.txt templates/account/email/login_notification.txt",
        "mv templates/account/email/password_change_message.txt templates/account/email/password_change.txt",
        "mv templates/account/email/ad_expiration_message.txt templates/account/email/ad_expiration.txt"
      ]
    },
    {
      "priority": 1,
      "type": "CODE_UPDATE",
      "action": "Corriger le chemin du template dans send_account_created_email",
      "file": "accounts/tasks.py",
      "line": 142,
      "change": {
        "from": "template_name=\"account_created\",",
        "to": "template_name=\"account/email/account_created\","
      }
    },
    {
      "priority": 2,
      "type": "TESTING",
      "action": "Créer des tests automatisés pour vérifier la cohérence",
      "tests": [
        "Vérifier que chaque template_name a un .html et .txt correspondant",
        "Vérifier que les contextes contiennent les variables requises",
        "Tester l'envoi de chaque type d'email en dev"
      ]
    }
  ],
  
  "impact_analysis": {
    "current_behavior": "Les emails sont envoyés mais sans version texte optimale",
    "risks": [
      "Risque accru de détection spam (pas de version texte)",
      "Expérience dégradée pour utilisateurs sans HTML",
      "Template HTML account_created.html jamais utilisé"
    ],
    "after_fix": "Tous les emails auront une version HTML et texte optimales"
  }
}
